{% extends "base_header.html" %}
{% block title %} Sales Page{% endblock %}

{% block content %}
<script>
  function addProductRow() {
    console.log("Adding product row");
    const tableBody = document.querySelector('#productTable tbody');
    const newRow = document.createElement('tr');

    // Product dropdown
    const productCell = document.createElement('td');
    const productSelect = document.createElement('select');
    productSelect.name = 'products[]';
    {% for product in products %}
      productSelect.innerHTML += `<option value="{{ product[0] }}">{{ product[1] }}</option>`;
    {% endfor %}
    productCell.appendChild(productSelect);

    // Quantity input
    const quantityCell = document.createElement('td');
    const quantityInput = document.createElement('input');
    quantityInput.type = 'number';
    quantityInput.name = 'quantities[]';
    quantityInput.min = 1;
    quantityInput.required = true;
    quantityCell.appendChild(quantityInput);

    // Delete button
    const deleteCell = document.createElement('td');
    const deleteButton = document.createElement('button');
    deleteButton.type = 'button';
    deleteButton.textContent = 'Delete';
    deleteButton.onclick = function() {
      tableBody.removeChild(newRow);
    };
    deleteCell.appendChild(deleteButton);

    // Append cells to the new row
    newRow.appendChild(productCell);
    newRow.appendChild(quantityCell);
    newRow.appendChild(deleteCell);

    // Append the new row to the table body
    tableBody.appendChild(newRow);
  }

  function deleteSale(saleID) { 
      if (confirm("Are you sure you want to delete this sale?")) {
          // Make an AJAX request to the server to delete the sale
          var xhr = new XMLHttpRequest();
          
          xhr.onreadystatechange = function() {
              if (xhr.readyState === XMLHttpRequest.DONE) {
                  if (xhr.status === 200) {
                      // Successful response from the server
                      alert("Sale successfully deleted");
                      // You might want to reload the page or update the UI here
                      location.reload(); // This reloads the page; you can replace it with more sophisticated UI updates
                  } else {
                      // Handle error response from the server
                      alert("Error deleting sale");
                  }
              }
          };
          
          xhr.open("DELETE", "/sales/" + saleID, true);
          xhr.send();
      }
  }
  
  function editSale(saleID) {
        // Redirect to the editProduct route with the specified productID
        window.location.href = "/editSale/" + saleID;
    }

</script>

<div class="container-fluid mt-4">
  <h2>Sales</h2>
  <table>
    <tr align="middle">
      <th>ID</th>
      <th>Customer</th>
      <th>Sale Total</th>
      <th><a href="/sales#addSale" class="btn btn-outline-primary"><IMG SRC="{{url_for('static', filename='new_icon.png')}}" width = "25" height = "25"> New</a></th>
      <th></th>
    </tr>

    <!-- Iterates through each item in sales -->
    {% for sale in sales %}
    <tr align="middle">
        <td>{{ sale[0] }} </td>
        <td>{{ sale[1] }} </td>
        <td>${{ sale[2] }} </td>
        <td><a href="#" onClick="editSale({{ sale[0] }})" class="btn btn-outline-success"> <IMG SRC="{{url_for('static', filename='edit_icon.png')}}" width = "25" height = "25">Edit</a></td>
        <td><a href="#" onclick="deleteSale({{ sale[0] }})" class="btn btn-outline-danger"> <IMG SRC="{{url_for('static', filename='delete_icon.png')}}" width = "25" height = "25">Delete</a></td>
    </tr>
    {% endfor %}
  </table>
</div> <!-- sales --end -->


<div class="container-fluid mt-4">
    <h2>Sold Products</h2>
    <!-- Header for soldProducts Table -->
      <table>
        <tr>
          <th>ID</th>
          <th>SaleID</th>
          <th>Product Name</th>
          <th>Quantity Sold</th>
          <th>Line Total</th>
        </tr>
        <!-- Iterates through each item in soldProducts -->
        {% for sold in soldProducts %}
        <tr align="middle">
            <td>{{ sold[0] }} </td>
            <td>{{ sold[1] }} </td>
            <td>{{ sold[2] }} </td>
            <td>{{ sold[3] }} </td>
            <td>${{ sold[4] }} </td>
        </tr>
        {% endfor %}
      </table>
</div> <!-- soldProducts -- end -->


<div class="container-fluid mt-4">
  <form method="POST" name="addSale" id="addSale" action="/sales#addSale">
    <legend style="font-size:20px"><strong>Add a Sale<IMG SRC="{{url_for('static', filename='new_icon.png')}}" width = "25" height = "25"></strong></legend>
      <label for="customer">Customer </label>
      <select name="customer" id="customer">
        {% for customer in customers %}
        <option value="{{ customer[0] }}"> {{ customer[1] }}</option>
        {% endfor %}  
      </select>

      <table id="productTable">
        <thead>
          <tr>
            <th>Product</th>
            <th>Quantity</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>

        </tbody>
      </table>
      
      <button type="button" onclick="addProductRow()" class="btn btn-outline-info">Add Product</button>
      <button type="submit" class="btn btn-outline-primary">Submit Sale</button>
      <a href="/sales#" class="btn btn-outline-secondary mt-1">Back to Top</a>
  </form>
</div><!-- insert -- end -->



{% endblock %}